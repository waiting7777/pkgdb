<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html" charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <title>Visitor</title>

        <script src="https://unpkg.com/vue@latest/dist/vue.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

        <style>
            html, body{
                font-size: 16px;
            }
            input{
                width: 50px;
            }
        </style>

    </head>
    <body>
        <div class="container" id="visitor">
            <div class="row">
                <div class="col-md-12" id="vistor-stat">
                    <br>
                    <p>訪客記錄</p>
                    <table class="table table-bordered table-hover table-striped">
                        <thead>
                            <tr>
                                <td>user_id</td>
                                <td>arrival</td>
                                <td>departure</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="visitor in logs">
                                <td>{{visitor.user_id}}</td>
                                <td>{{visitor.arrival}}</td>
                                <td>{{visitor.departure}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-12">
                    <p>輸入查詢時間範圍</p>
                    <div class="col-md-12">
                        起 :
                        <input type="text" v-model="starttime.year">
                        <label for="">年</label>
                        <input type="text" v-model="starttime.month">
                        <label for="">月</label>
                        <input type="text" v-model="starttime.day">
                        <label for="">日</label>
                        <input type="text" v-model="starttime.hour">
                        <label for="">時</label>
                        <input type="text" v-model="starttime.minute">
                        <label for="">分</label>
                        <input type="text" v-model="starttime.second">
                        <label for="">秒</label>
                    </div>
                    <div class="col-md-12">
                        訖 :
                        <input type="text" v-model="endtime.year">
                        <label for="">年</label>
                        <input type="text" v-model="endtime.month">
                        <label for="">月</label>
                        <input type="text" v-model="endtime.day">
                        <label for="">日</label>
                        <input type="text" v-model="endtime.hour">
                        <label for="">時</label>
                        <input type="text" v-model="endtime.minute">
                        <label for="">分</label>
                        <input type="text" v-model="endtime.second">
                        <label for="">秒</label>
                    </div>
                </div>
                <div class="col-md-12">
                    <br>
                    <button class="btn btn-primary" v-on:click="caculate">Caculate</button>
                    <br style="clear:both;">
                    <br>
                    <p>max visitor in time periods is {{max}}</p>
                </div>
            </div>
        </div>
        <script>
            let logs=[{
                user_id : 0,
                type : 'arrival',
                time : 1480910400000
            },
            {
                user_id : 0,
                type : 'departure',
                time : 1480921200000
            },
            {
                user_id : 1,
                type : 'arrival',
                time : 1480906800000
            },
            {
                user_id : 1,
                type : 'departure',
                time : 1480924800000
            },
            {
                user_id : 2,
                type : 'arrival',
                time : 1480914000000
            },
            {
                user_id : 2,
                type : 'departure',
                time : 1480915800000
            },
            {
                user_id : 3,
                type : 'arrival',
                time : 1480912200000
            },
            {
                user_id : 3,
                type : 'departure',
                time : 1480926600000
            },
            {
                user_id : 4,
                type : 'arrival',
                time : 1480899600000
            },
            {
                user_id : 4,
                type : 'departure',
                time : 1480910400000
            }];


            function log(user_id, type, time){

                logs.push({
                    user_id:user_id,
                    type:type,
                    time:time
                });

            }



            function max_vistors(time_start, time_end){

                let vistors_in_building = {};
                let max=0;


                logs.sort(function(a, b){
                    return a.time - b.time;
                });

                console.log(logs);

                let _count =function(){
                    let c=0;
                    for(let user_id in vistors_in_building){
                        c++;
                    }

                    return c;
                };

                for(let i=0,imax=logs.length; i<imax; i++){
                    let l = logs[i];

                    if(l.time <= time_end){
                        if(l.type === 'arrival'){
                            vistors_in_building[l.user_id] = l.time;
                        }

                        if(l.type === 'departure'){
                            delete vistors_in_building[l.user_id];
                        }
                    }

                    if( l.time >= time_start && l.time <= time_end){
                        num = _count();
                        max = Math.max(max, num);
                    }
                }
                return max;
            }

            VM = new Vue({
                el : '#visitor',
                data : {
                    logs : [],
                    starttime : {},
                    endtime : {},
                    max : 0
                },
                created : function(){
                    for(var i in logs){
                        if(!this.logs[logs[i]['user_id']]){
                            this.logs[logs[i]['user_id']] = {};
                            this.logs[logs[i]['user_id']]['user_id'] = logs[i]['user_id'];
                        }
                        if(logs[i]['type'] == 'arrival'){
                            var d = new Date(logs[i]['time']);
                            this.logs[logs[i]['user_id']]['arrival'] = d.toLocaleString();
                        }
                        else{
                            var d = new Date(logs[i]['time']);
                            this.logs[logs[i]['user_id']]['departure'] = d.toLocaleString();
                        }
                    }
                },
                methods : {
                    caculate : function(){
                        s = new Date(this.starttime.year, this.starttime.month-1, this.starttime.day, this.starttime.hour, this.starttime.minute, this.starttime.second);
                        start_time = s.getTime();
                        e = new Date(this.endtime.year, this.endtime.month-1, this.endtime.day, this.endtime.hour, this.endtime.minute, this.endtime.second);
                        end_time = e.getTime();
                        console.log(start_time, end_time);
                        console.log(max_vistors(start_time, end_time));
                        this.max = max_vistors(start_time, end_time);
                    }
                }
            });
        </script>
    </body>
</html>
